<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang>
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">






















<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=6.0.0" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.0.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=6.0.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.0.0">


  <link rel="mask-icon" href="/images/logo.svg?v=6.0.0" color="#222">





  <meta name="keywords" content="Hexo, NexT">










<meta property="og:type" content="website">
<meta property="og:title" content="categories">
<meta property="og:url" content="http://blog.fxti.xyz/categories/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:locale" content="default">
<meta property="og:updated_time" content="2019-03-28T16:40:56.663Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="categories">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '6.0.0',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://blog.fxti.xyz/categories/">





  <title>Decrypting-Dropshot-Malware-with-Radare2-and-Cutter–Part1 | Hexo</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="default">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"> <div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Hexo</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            Archives
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.fxti.xyz/2019/02/12/Decrypting-Dropshot-Malware-with-Radare2-and-Cutter–Part1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="FX-Ti">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Decrypting-Dropshot-Malware-with-Radare2-and-Cutter–Part1</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-02-12T13:18:28+00:00">2019-02-12</time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="用Radare2和Cutter解密APT33的Dropshot恶意程序-第一部分"><a href="#用Radare2和Cutter解密APT33的Dropshot恶意程序-第一部分" class="headerlink" title="用Radare2和Cutter解密APT33的Dropshot恶意程序 - 第一部分"></a>用Radare2和Cutter解密APT33的Dropshot恶意程序 - 第一部分</h1><p>译自：</p>
<blockquote>
<p><a href="https://www.megabeets.net/decrypting-dropshot-with-radare2-and-cutter-part-1/" target="_blank" rel="noopener">https://www.megabeets.net/decrypting-dropshot-with-radare2-and-cutter-part-1/</a></p>
</blockquote>
<h2 id="序言"><a href="#序言" class="headerlink" title="序言"></a>序言</h2><p>作为一个逆向工程师和恶意程序研究员，工具对我来说非常重要。我花费了很多时间搭建最好的恶意程序分析环境并选择对我的需求来说最棒的工具。过去两年中，Radare2是我在自动化逆向、脚本编写、CTF等等情境下的趁手工具。但这也意味着，我几乎从不用Radare2分析Windows环境下的恶意程序。主要原因是Radare2的命令行操作太过笨拙、复杂。IDA Pro更适合这种工作，能够快速查看函数、数据结构、重命名、注释等等。IDA Pro用起来感觉更符合直觉，这正是我做恶意软件分析时所需要的。然后Cutter问世了。</p>
<a id="more"></a> 
<img src="/FXTi/2019/02/12/Decrypting-Dropshot-Malware-with-Radare2-and-Cutter–Part1/cutter.png">
<h2 id="Cutter"><a href="#Cutter" class="headerlink" title="Cutter"></a>Cutter</h2><p>几年以来，Radare2社区尝试过开发很多Radare2的图形界面，但没有一个比得上Cutter的。Cutter是一个基于QT C++的Radare图形前端。我觉得Cutter才是配得上Radare2的GUI。以下引用自<a href="https://github.com/radareorg/cutter" target="_blank" rel="noopener">Cutter的Github主页</a></p>
<blockquote>
<p>Cutter并不是面向Radare2的现有用户开发的，它是为了受困于Radare2陡峭的学习曲线的用户所开发的。因为他们不喜欢命令行界面或是Radare2实在太难学了。</p>
</blockquote>
<p>Cutter是一个只开发了一年的新项目，并且是唯一一个官方宣布的Radare的GUI项目。Cutter不仅通过友好且现代图形界面让用户充分使用Radare2功能，而且实现了跨平台。在篇文章中我将展示Cutter的功能以及如何使用，虽然这工具很符合直觉，你可能只靠自己就学会了。</p>
<h3 id="下载并安装Cutter"><a href="#下载并安装Cutter" class="headerlink" title="下载并安装Cutter"></a>下载并安装Cutter</h3><p>Cutter全平台可用(Linux, OS X, Windows)。你既可以直接从<a href="https://github.com/radareorg/cutter/releases" target="_blank" rel="noopener">这里</a>下载，也能从源码自己编译来获取实时更新:</p>
<p>首先克隆仓库:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> --recurse-submodules https://github.com/radareorg/cutter</span><br><span class="line"><span class="built_in">cd</span> cutter</span><br></pre></td></tr></table></figure>
<p>Linux编译</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./build.sh</span><br></pre></td></tr></table></figure>
<p>Windows编译</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">prepare_r2.bat</span><br><span class="line">build.bat</span><br></pre></td></tr></table></figure>
<p>如果出错了请看<a href="https://github.com/radareorg/cutter/blob/master/docs/Compiling.md" target="_blank" rel="noopener">这里</a>。</p>
<h2 id="Dropshot-StoneDrill"><a href="#Dropshot-StoneDrill" class="headerlink" title="Dropshot \ StoneDrill"></a>Dropshot \ StoneDrill</h2><p>Dropshot也叫做StoneDrill是一款和APT33组织相关的格盘恶意软件(对硬盘进行恶意清理行为)。该组织主要目标是沙特阿拉伯境内的组织。Dropshot是一个复杂的恶意软件样本，采用了高级反模拟技术并且有很多功能。该恶意软件极可能和<a href="https://en.wikipedia.org/wiki/Shamoon" target="_blank" rel="noopener">Shamoon恶意软件</a>有关。Dropshot先后被<a href="https://app.box.com/s/olc867zxc9nkjzm3wkjwi0b0e2awahtn" target="_blank" rel="noopener">Kaspersky</a>和<a href="https://www.fireeye.com/blog/threat-research/2017/09/apt33-insights-into-iranian-cyber-espionage.html" target="_blank" rel="noopener">FireEye</a>深入分析。在这篇文章中关注于分析Dropshot如何在内部解密字符串来规避分析。在第二部分会分析Dropshot中包含实际载荷的加密资源的解密过程。</p>
<p>该样本可以再<a href="https://github.com/ITAYC0HEN/A-journey-into-Radare2/blob/master/Part%203%20-%20Malware%20analysis/dropshot.exe.zip" target="_blank" rel="noopener">这里</a>下载(密码:<em>infected</em>)。</p>
<p><strong>注意这是一个真正的恶意软件，而且会破坏硬盘数据！请小心处理</strong></p>
<p>推荐使用Linux机器进行静态分析。</p>
<h2 id="开始"><a href="#开始" class="headerlink" title="开始"></a>开始</h2><p>既然安装好了Cutter，现在启动并开始分析。启动Cutter后在’Open File’标签下选择新文件点击’open’。打开文件之后出现’Load Options’窗口，通过这个会话窗口告知Radare2如何分析这个文件。展开’Advanced options’，就能够选择特定的架构、CPU、文件格式等等。</p>
<img src="/FXTi/2019/02/12/Decrypting-Dropshot-Malware-with-Radare2-and-Cutter–Part1/load.png">
<p>为了分析的更加准确，我移动Analysis下面的拖动条来指定分析模式。然后去掉<code>Autorename functions based on context (aan)</code>选框来关闭函数的自动重命名功能。因为对于这个样本<code>aan</code>所使用的算法会使得一部分函数名难以理解。</p>
<p>点击’OK’之后就能看到Cutter的主窗口了，你的可能和图中的不一样但界面很好配置。比如点击”View-&gt;Preferences”，你就能修改主题颜色并且配置生成的汇编代码样式。窗口中的空间很灵活可以随意摆放，也能从”Windows”菜单中添加想要的新控件，花几分钟配置一下可以让Cutter更加趁手。</p>
<img src="/FXTi/2019/02/12/Decrypting-Dropshot-Malware-with-Radare2-and-Cutter–Part1/load.png">
<h2 id="基本静态分析"><a href="#基本静态分析" class="headerlink" title="基本静态分析"></a>基本静态分析</h2><p>当开始分析一款恶意软件，我经常先进行静态分析。基本的静态分析有时能判别该程序是否是恶意的，以及它的功能和基本情况。虽然基本的静态分析很直接而且方便，但是对于复杂的恶意软件来说依旧很不高效。所以在阅读汇编代码之前，让我们看看几款控件能告诉我们什么。</p>
<h3 id="字符串控件"><a href="#字符串控件" class="headerlink" title="字符串控件"></a>字符串控件</h3><p>通过字符串空间没看到什么有趣的东西。有些看起来像文件名的字符串，比如”C-Dlt-C-Org-T.vbs”和”C-Dlt-C-Trsh-T.tmp”。还能看到一些熟悉API的函数名和库名，但没有什么需要注意的。</p>
<h3 id="熵分析控件-Entropy"><a href="#熵分析控件-Entropy" class="headerlink" title="熵分析控件(Entropy)"></a>熵分析控件(Entropy)</h3><p>另一个值得一看的属性是文件的熵。简单地说，熵(当前语境)是给定数值集合中随机性的量度。计算出的文件的熵在不同的文件中是相似的，一般在0.0到8.0之间。熵的值可靠地反映了该文件是否被打包、压缩或者内部包含打包、压缩的数据。一个打包过的二进制文件很可能有高熵值。至于多高，有的人说6.0足够高了，有的人说7.0及以上。我偏向于6.8作为二进制文件经过压缩或打包的标志。</p>
<p>通过Dashboard控件能简单查看熵值。</p>
<img src="/FXTi/2019/02/12/Decrypting-Dropshot-Malware-with-Radare2-and-Cutter–Part1/hash.png">
<p>可以看到这个文件的熵值是7.1，很有可能是经过压缩打包的文件。通过Section控件能够详细地看到各个区段的熵值:</p>
<img src="/FXTi/2019/02/12/Decrypting-Dropshot-Malware-with-Radare2-and-Cutter–Part1/section.png">
<p>看看<code>.rsrc</code>段的熵值有多高，记住最高的熵值就是8.0了。毫无疑问，有些有意思的数据就存放在<code>.rsrc</code>段。我们将在这系列的第二部分详细分析。</p>
<h2 id="理解字符串解密过程"><a href="#理解字符串解密过程" class="headerlink" title="理解字符串解密过程"></a>理解字符串解密过程</h2><p>当我浏览Dropshot的代码时，我发现他使用了一个不太复杂的方法去解密它的内置字符串(大部分)。该函数在分析中被注意到是因为它被调用了很多次而且主要是在<code>LoadLibraryA</code>和<code>GetProcAddress</code>的调用之前。所以看起来是该程序是动态加载库和函数来迷惑分析人员的，该方法在恶意软件的编写中相当常见。这篇文章的目的不是为了分析清楚Dropshot的每个部分，而是介绍Cutter和Radare2脚本能够怎样使恶意软件分析人员受益，所以我会跳过寻找解密函数位置的详细过程。</p>
<p>正如之前所说的，我找到解密函数归功于它的高频次出现和在程序流中的重要性。如果你想凭自己的能力寻找它，请现在完成。</p>
<p>现在公布答案，解密函数位于<code>0x4012a0</code>，接受两个参数。下图会展示该函数的被调用现场。</p>
<img src="/FXTi/2019/02/12/Decrypting-Dropshot-Malware-with-Radare2-and-Cutter–Part1/disas.png">
<p>图中的函数(<code>0x4017a0</code>)传递两个参数进入解密函数(<code>0x4012a0</code>)。第一个参数是地址<code>0x41b8cc</code>，第二个参数是<code>0xb</code>(十进制11)。是时候重命名这个解密函数方便分析了。简单的点击<code>fcn.004012a0</code>然后输入<code>Shift + N</code>或者右键点击<code>Rename fcn.004012a0</code>，输入新名字(<code>strings_decrypter</code>)然后点击’OK’。</p>
<img src="/FXTi/2019/02/12/Decrypting-Dropshot-Malware-with-Radare2-and-Cutter–Part1/rename.png">
<p>然后我们能看到<code>strings_decrypter</code>的输出(<code>eax</code>)和另一个值1被作为参数被传给另一个函数<code>0x4013b0</code>。查看一下这个函数:</p>
<img src="/FXTi/2019/02/12/Decrypting-Dropshot-Malware-with-Radare2-and-Cutter–Part1/graph2.png">
<p>如果传递参数是0(<code>eax == 0</code>)该函数执行右分支，反之则是左分支。不论如何都会调用<code>LoadLibraryA</code>并传递经过解密函数得到的字符串作为参数。事实上右分支会加载<code>ntdll.dll</code>，左分支会加载<code>kernel32.dll</code>。简单来说，这个函数会加载需要的库来使用其中的函数，所以重命名该函数为<code>load_ntdll_or_kernel32</code>。</p>
<p>在按需加载了需要的库之后，该函数对应库的句柄和解密的字符串调用<code>GetProcAddress</code>。我们能确定这个字符串是<code>kernel32.dll</code>导出的API函数名之一，几条指令之后这个加载的函数被调用。</p>
<p>正因尚且还不知道什么API函数会被调用，我们需要理解<code>strings_decrypter</code>如何工作以及传送的是参数实际上是什么。</p>
<h2 id="分析解密函数"><a href="#分析解密函数" class="headerlink" title="分析解密函数"></a>分析解密函数</h2><p>这是Cutter生成的解密函数图:</p>

<p>显然我们不会一步一步推敲这个函数，但仍需弄清总体思路。已知该函数接受两个参数，第一个是地址(<code>arg_8h</code>)，第二个是数字(<code>arg_ch</code>)。在第一块(始于<code>0x4012a0</code>)，能看到通过<code>VirtualAlloc</code>分配了大小为<code>arg+ch+1</code>的一块缓存区。然后把分配的缓存区地址保存到<code>local_8h</code>，把它重命名为<code>buffer</code>。</p>
<img src="/FXTi/2019/02/12/Decrypting-Dropshot-Malware-with-Radare2-and-Cutter–Part1/rename2.png">
<p>之后0被存入<code>local+4h</code>。下一块是循环的开始，存储在<code>arg_ch</code>的值被传入<code>edx</code>每轮与<code>local_4h</code>进行比对。能想到<code>arg_ch</code>存储的是长度并且<code>local_4h</code>是循环的下标，所以分别重命名为<code>length</code>和<code>index</code>。现在弄明白了两个局部变量和一个参数，还剩下保存着地址的<code>arg_8h</code>。在这个例子中能看到<code>0x41b8cc</code>被传输进了<code>strings_decrypter</code>函数。打开Hexdump控件然后在上端的文本框输入<code>0x41b8cc</code>定位到该地址，能看到从<code>0x41b8cc</code>起始到<code>0x0041b8e1</code>结束的2字节字符串。选取这一段，就能通过右侧的工具栏就能够方便的生成它的C数组形式数据。</p>
<img src="/FXTi/2019/02/12/Decrypting-Dropshot-Malware-with-Radare2-and-Cutter–Part1/hexdump.png">
<p>这功能确实挺方便的，Cutter能生成不同类型的数组形式来方便脚本编写，例如:</p>
<p><strong>C half-words(Little Endian):</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _BUFFER_SIZE 11</span></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">uint16_t</span> buffer[<span class="number">11</span>] = &#123;</span><br><span class="line">  <span class="number">0x0005</span>, <span class="number">0x0006</span>, <span class="number">0x000e</span>, <span class="number">0x0006</span>, <span class="number">0x001c</span>, <span class="number">0x0006</span>, <span class="number">0x0007</span>, <span class="number">0x000b</span>,</span><br><span class="line">  <span class="number">0x000e</span>, <span class="number">0x0006</span>, <span class="number">0x0022</span>&#125;;</span><br></pre></td></tr></table></figure>
<p><strong>Python:</strong><br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> struct</span><br><span class="line">buf = struct.pack (<span class="string">"22B"</span>, *[</span><br><span class="line"><span class="number">0x05</span>,<span class="number">0x00</span>,<span class="number">0x06</span>,<span class="number">0x00</span>,<span class="number">0x0e</span>,<span class="number">0x00</span>,<span class="number">0x06</span>,<span class="number">0x00</span>,<span class="number">0x1c</span>,<span class="number">0x00</span>,<span class="number">0x06</span>,</span><br><span class="line"><span class="number">0x00</span>,<span class="number">0x07</span>,<span class="number">0x00</span>,<span class="number">0x0b</span>,<span class="number">0x00</span>,<span class="number">0x0e</span>,<span class="number">0x00</span>,<span class="number">0x06</span>,<span class="number">0x00</span>,<span class="number">0x22</span>,<span class="number">0x00</span>])</span><br></pre></td></tr></table></figure></p>
<p><strong>Javascript:</strong><br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> buffer = <span class="keyword">new</span> Buffer(<span class="string">"BQAGAA4ABgAcAAYABwALAA4ABgAiAA=="</span>, <span class="string">'base64'</span>);</span><br></pre></td></tr></table></figure></p>
<p>这数组会方便之后的脚本编写,现在先继续<code>strings_decrypter</code>的分析工作。进入循环能看到<code>eax</code>会保存<code>index</code>并且<code>edx</code>会保存之前提到的数组，之后<code>[ecx + eax*2]</code>的一字节传入<code>edx</code>。所以这里<code>edx</code>等于<code>half_word_array[index*2]</code>。之后缓存区被移到<code>eax</code>并被加上<code>index</code>的值，把<code>eax</code>设置到缓存区上特定偏移的位置。然后在<code>0x004012eb</code>能看到从一串预定义的字符串的<code>[edx]</code>偏移位置读入1字节到<code>cl</code>，双击那串字符串能看到全貌:<code>AaCcdDeFfGhiKLlMmnNoOpPrRsSTtUuVvwWxyZz32.\EbgjHI _YQB:&quot;/@\x0a\x0d\x1a</code>。最后从<code>cl</code>拷贝那1比特到<code>buffer</code>的特定偏移位置，这个循环持续<code>length</code>次。</p>
<p>在这所有之后可以下结论说<code>arg_8h</code>保存的地址是一个偏移量构成的数组，每个偏移量对应预定义字符串中的字符，并且<code>length</code>是将要构造出的解密字符串的长度。由上，Dropshot通过给出偏移量数组的地址和字符串长度来构造出解密字符串。接下来用Python确认一下。</p>
<p>这又可以用到Cutter的一个功能，内置<a href="http://jupyter-notebook-beginner-guide.readthedocs.io/en/latest/what_is_jupyter.html" target="_blank" rel="noopener">Jupyter notebook</a>。我们不需要打开额外的Python命令行，直接可以使用Jupyter控件。</p>
<img src="/FXTi/2019/02/12/Decrypting-Dropshot-Malware-with-Radare2-and-Cutter–Part1/jupyter.png">
<p>这功能太棒了！</p>
<p>接下来快速写个PoC试试:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># The pre-defined decryption table (the string)</span></span><br><span class="line">decryption_table = <span class="string">'AaCcdDeFfGhiKLlMmnNoOpPrRsSTtUuVvwWxyZz32.\EbgjHI _YQB:"/@\x0a\x0d\x1a'</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># The offsets array (0x41b8cc) which is passed to the function</span></span><br><span class="line">offsets_array = [</span><br><span class="line"><span class="number">0x05</span>,<span class="number">0x00</span>,<span class="number">0x06</span>,<span class="number">0x00</span>,<span class="number">0x0e</span>,<span class="number">0x00</span>,<span class="number">0x06</span>,<span class="number">0x00</span>,<span class="number">0x1c</span>,<span class="number">0x00</span>,<span class="number">0x06</span>,</span><br><span class="line"><span class="number">0x00</span>,<span class="number">0x07</span>,<span class="number">0x00</span>,<span class="number">0x0b</span>,<span class="number">0x00</span>,<span class="number">0x0e</span>,<span class="number">0x00</span>,<span class="number">0x06</span>,<span class="number">0x00</span>,<span class="number">0x22</span>,<span class="number">0x00</span>]</span><br><span class="line"> </span><br><span class="line"><span class="comment"># The length which is passed to the function</span></span><br><span class="line">length = <span class="number">11</span></span><br><span class="line"> </span><br><span class="line">decrypted_string = <span class="string">''</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(length):</span><br><span class="line">    decrypted_string += decryption_table[ offsets_array[ i*<span class="number">2</span> ] ]</span><br><span class="line"> </span><br><span class="line"><span class="keyword">print</span> (<span class="string">"Decrypted: %s"</span> % (decrypted_string))</span><br></pre></td></tr></table></figure>
<p>在Jupyter中运行:</p>
<img src="/FXTi/2019/02/12/Decrypting-Dropshot-Malware-with-Radare2-and-Cutter–Part1/run.png">
<p>好的，能看到成功解密得到了”DeleteFileW”这个API函数名，于是能确认<code>arg_8h</code>和推测的一样。</p>
<p>现在弄明白了<code>strings_decrypter</code>是如何工作甚至解密了一条字符串，那就看看那里调用了这个函数并且全部解密来看一看。要看到<code>strings_decrypter</code>的交叉引用，点击它的名字并且按”X”。这会打开xrefs窗口，Cutter会显示出每个引用的预览信息来简化工作。</p>
<img src="/FXTi/2019/02/12/Decrypting-Dropshot-Malware-with-Radare2-and-Cutter–Part1/xrefs.png">
<p>能看到不少<code>strings_decrypter</code>的调用，多的不适合手动解密，这便是Radare2和Cutter通过脚本配合完成工作的合适情景了。</p>
<h2 id="通过脚本自动解密字符串"><a href="#通过脚本自动解密字符串" class="headerlink" title="通过脚本自动解密字符串"></a>通过脚本自动解密字符串</h2><p>得益于<a href="https://github.com/radare/radare2-r2pipe" target="_blank" rel="noopener">r2pipe</a>，脚本控制Radare2非常简单。</p>
<blockquote>
<p>r2pipe的API基于<code>r_core_cm_str()</code>这一函数，他接受一个字符串指令然后返回字符串结果</p>
</blockquote>
<p>r2pipe支持很多编程语言包括Python, NodeJS, Rust, C等等。</p>
<p>幸运的是Cutter内置的Jupyter控件包括了<code>r2pipe</code>这个库，按照过程写出r2pipe脚本:</p>
<ul>
<li>声明已知的常量、变量和函数包括解密函数、解密所用的预定义字符串</li>
<li>导出预定义字符串并保存</li>
<li>迭代所有访问预定义字符串的下标并保存变换后的字符</li>
<li>手动解密所有字符串</li>
<li>打印出解密好的字符串并在汇编代码中进行注释方便之后的进一步分析</li>
</ul>
<p>首先定义我们已知的部分的地址:预定义字符串(解密表)和解密函数。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> cutter</span><br><span class="line"> </span><br><span class="line"><span class="comment"># Declaration of decryption-table related variables</span></span><br><span class="line">decryption_table = <span class="number">0x41BA3C</span></span><br><span class="line">decryption_table_end = <span class="number">0x41BA77</span></span><br><span class="line">decryption_table_len = decryption_table_end - decryption_table</span><br><span class="line">decryption_function = <span class="number">0x4012A0</span></span><br></pre></td></tr></table></figure>
<p>之后需要让Radare2分析二进制文件来检测交叉引用和函数。<code>aa</code>是Radare2的基本的分析指令，而<code>cutter.cmd</code>是接受radare2指令并返回对应输出的交互函数。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cutter.cmd(<span class="string">'aa'</span>)</span><br></pre></td></tr></table></figure>
<p>之后导出解密表的内容到一个变量。<code>pxj</code>是用来打印16进制值的，j后缀标识返回JSON，并且<code>cutter.cmdj</code>会帮我们解析JSON输出内容、</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Dump the decryption table to a variable</span></span><br><span class="line">decryption_table_content = cutter.cmdj(</span><br><span class="line">    <span class="string">"pxj %d @ %d"</span> % (decryption_table_len, decryption_table))</span><br></pre></td></tr></table></figure>
<p>现在我们有了所需的数据去迭代获取解密函数中对应的下标内容。</p>
<p>用Python的<code>for</code>迭代<code>axtj</code>指令的输出，这指令分析到地址的交叉引用并列出。每次循环中首先获取调用解密函数的两个参数，分别是偏移数组所在地址和字符串长度。通过<code>pdj -2 @ &lt;some xref address&gt;</code>可以获取，<code>pdj</code>显示汇编结果、<code>-2</code>显示当前地址之前的2个汇编指令。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Iterate x-refs to the decryption function</span></span><br><span class="line"><span class="keyword">for</span> xref <span class="keyword">in</span> cutter.cmdj(<span class="string">'axtj %d'</span> % decryption_function):</span><br><span class="line">    <span class="comment"># Get the arguments passed to the decryption function: length and encrypted string</span></span><br><span class="line">    length_arg, offsets_arg = cutter.cmdj(<span class="string">'pdj -2 @ %d'</span> % (xref[<span class="string">'from'</span>]))</span><br><span class="line"> </span><br><span class="line">    <span class="comment"># String variable to store the decrypted string</span></span><br><span class="line">    decrypted_string = <span class="string">""</span></span><br><span class="line"> </span><br><span class="line">    <span class="comment"># Guard rail to avoid exception</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">not</span> <span class="string">'val'</span> <span class="keyword">in</span> length_arg):</span><br><span class="line">        <span class="keyword">continue</span></span><br></pre></td></tr></table></figure>
<p>接下来是关键的解密部分，既然已经做过了PoC那么直接用<code>for</code>循环实现逻辑:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Manually decrypt the encrypted string</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>, length_arg[<span class="string">'val'</span>]):</span><br><span class="line">        decrypted_string += chr(decryption_table_content[cutter.cmdj(</span><br><span class="line">            <span class="string">'pxj 1 @ %d'</span> % (offsets_arg[<span class="string">'val'</span>] + (i*<span class="number">2</span>)))[<span class="number">0</span>]])</span><br></pre></td></tr></table></figure>
<p>好了现在<code>decrypted_string</code>保存着解密的结果，接下来打印出来并且完成注释就行。<code>CC</code>指令用来添加注释:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Print the decrypted and the address it was referenced to the console</span></span><br><span class="line">    print(decrypted_string + <span class="string">" @ "</span> + hex(xref[<span class="string">'from'</span>]))</span><br><span class="line"> </span><br><span class="line">    <span class="comment"># Add comments to each call of the decryption function</span></span><br><span class="line">    cutter.cmd(<span class="string">'CC Decrypted: %s @ %d'</span> % (decrypted_string, xref[<span class="string">'from'</span>]))</span><br></pre></td></tr></table></figure>
<p>最后组合在一起就得到了最终的脚本:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> cutter</span><br><span class="line"> </span><br><span class="line"><span class="comment"># Declaration of decryption-table related variables</span></span><br><span class="line">decryption_table = <span class="number">0x41BA3C</span></span><br><span class="line">decryption_table_end = <span class="number">0x41BA77</span></span><br><span class="line">decryption_table_len = decryption_table_end - decryption_table</span><br><span class="line">decryption_function = <span class="number">0x4012A0</span></span><br><span class="line"> </span><br><span class="line">cutter.cmd(<span class="string">'aa'</span>)</span><br><span class="line"> </span><br><span class="line"><span class="comment"># Dump the decryption table to a variable</span></span><br><span class="line">decryption_table_content = cutter.cmdj(</span><br><span class="line">    <span class="string">"pxj %d @ %d"</span> % (decryption_table_len, decryption_table))</span><br><span class="line"> </span><br><span class="line"><span class="comment"># Iterate x-refs to the decryption function</span></span><br><span class="line"><span class="keyword">for</span> xref <span class="keyword">in</span> cutter.cmdj(<span class="string">'axtj %d'</span> % decryption_function):</span><br><span class="line">    <span class="comment"># Get the arguments passed to the decryption function: length and encrypted string</span></span><br><span class="line">    length_arg, offsets_arg = cutter.cmdj(<span class="string">'pdj -2 @ %d'</span> % (xref[<span class="string">'from'</span>]))</span><br><span class="line"> </span><br><span class="line">    <span class="comment"># String variable to store the decrypted string</span></span><br><span class="line">    decrypted_string = <span class="string">""</span></span><br><span class="line"> </span><br><span class="line">    <span class="comment"># Guard rail to avoid exception</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">not</span> <span class="string">'val'</span> <span class="keyword">in</span> length_arg):</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">        </span><br><span class="line">    <span class="comment"># Manually decrypt the encrypted string</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>, length_arg[<span class="string">'val'</span>]):</span><br><span class="line">        decrypted_string += chr(decryption_table_content[cutter.cmdj(</span><br><span class="line">            <span class="string">'pxj 1 @ %d'</span> % (offsets_arg[<span class="string">'val'</span>] + (i*<span class="number">2</span>)))[<span class="number">0</span>]])</span><br><span class="line"> </span><br><span class="line">    <span class="comment"># Print the decrypted and the address it was referenced to the console</span></span><br><span class="line">    print(decrypted_string + <span class="string">" @ "</span> + hex(xref[<span class="string">'from'</span>]))</span><br><span class="line"> </span><br><span class="line">    <span class="comment"># Add comments to each call of the decryption function</span></span><br><span class="line">    cutter.cmd(<span class="string">'CC Decrypted: %s @ %d'</span> % (decrypted_string, xref[<span class="string">'from'</span>]))</span><br><span class="line"> </span><br><span class="line">    <span class="comment"># Refresh the interface</span></span><br><span class="line">    cutter.refresh()</span><br></pre></td></tr></table></figure>
<p>把脚本粘贴进Cutter的Jupyter控件然后执行，完成后查看注释控件就能看到脚本的成果:</p>
<img src="/FXTi/2019/02/12/Decrypting-Dropshot-Malware-with-Radare2-and-Cutter–Part1/comments.png">
<p>还能看到汇编中的行内注释:</p>
<img src="/FXTi/2019/02/12/Decrypting-Dropshot-Malware-with-Radare2-and-Cutter–Part1/inline.png">
<p>真棒！完成了，解密了所有的API函数名并且完成了行内注释来方便之后的分析。最后的脚本能在<a href="https://github.com/ITAYC0HEN/A-journey-into-Radare2/blob/master/Part%203%20-%20Malware%20analysis/decrypt_dropshot.py" target="_blank" rel="noopener">这里</a>找到。</p>
<h2 id="尾声"><a href="#尾声" class="headerlink" title="尾声"></a>尾声</h2><p>这是用Radare2和Cutter解密APT33的Dropshot恶意程序的第一部分。我们熟悉了Cutter、Radare2 GUI并且用r2pipe写了一个解密脚本。</p>
<p>这系列的下一部分会分析Dropshot如何解密其中的实际载荷，所以敬请期待！</p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Security/" rel="tag"># Security</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/11/14/xiaomi-router-analysis/" rel="next" title="xiaomi-router-analysis">
                <i class="fa fa-chevron-left"></i> xiaomi-router-analysis
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2019/02/12/radare2-reverse-self-modified-binary/" rel="prev" title="radare2-reverse-self-modified-binary">
                radare2-reverse-self-modified-binary <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">FX-Ti</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">172</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">4</span>
                  <span class="site-state-item-name">tags</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#用Radare2和Cutter解密APT33的Dropshot恶意程序-第一部分"><span class="nav-number">1.</span> <span class="nav-text">用Radare2和Cutter解密APT33的Dropshot恶意程序 - 第一部分</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#序言"><span class="nav-number">1.1.</span> <span class="nav-text">序言</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Cutter"><span class="nav-number">1.2.</span> <span class="nav-text">Cutter</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#下载并安装Cutter"><span class="nav-number">1.2.1.</span> <span class="nav-text">下载并安装Cutter</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Dropshot-StoneDrill"><span class="nav-number">1.3.</span> <span class="nav-text">Dropshot \ StoneDrill</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#开始"><span class="nav-number">1.4.</span> <span class="nav-text">开始</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#基本静态分析"><span class="nav-number">1.5.</span> <span class="nav-text">基本静态分析</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#字符串控件"><span class="nav-number">1.5.1.</span> <span class="nav-text">字符串控件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#熵分析控件-Entropy"><span class="nav-number">1.5.2.</span> <span class="nav-text">熵分析控件(Entropy)</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#理解字符串解密过程"><span class="nav-number">1.6.</span> <span class="nav-text">理解字符串解密过程</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#分析解密函数"><span class="nav-number">1.7.</span> <span class="nav-text">分析解密函数</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#通过脚本自动解密字符串"><span class="nav-number">1.8.</span> <span class="nav-text">通过脚本自动解密字符串</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#尾声"><span class="nav-number">1.9.</span> <span class="nav-text">尾声</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">FX-Ti</span>

  

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/theme-next/hexo-theme-next">NexT.Gemini</a> v6.0.0</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>
























  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.0.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.0.0"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=6.0.0"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=6.0.0"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=6.0.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=6.0.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.0.0"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
